<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ssoj.backend.dao.ProblemMapper">

    <resultMap id="ProblemResultMap" type="com.ssoj.backend.entity.Problem">
        <id property="id" column="id" />
        <result property="title" column="title" />
        <result property="description" column="description" />
        <result property="inputFormat" column="input_format" />
        <result property="outputFormat" column="output_format" />
        <result property="sampleInput" column="sample_input" />
        <result property="sampleOutput" column="sample_output" />
        <result property="difficulty" column="difficulty" />
        <result property="timeLimit" column="time_limit" />
        <result property="memoryLimit" column="memory_limit" />
        <result property="authorId" column="author_id" />
        <result property="numberOfSubmissions" column="number_of_submissions" />
        <result property="numberOfAccepted" column="number_of_accepted" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
    </resultMap>

    <!-- 根据ID查询题目 -->
    <select id="findById" resultMap="ProblemResultMap"> SELECT * FROM problem WHERE id = #{id} </select>

    <!-- 查询所有题目（分页） -->
    <select id="findAll" resultMap="ProblemResultMap"> SELECT * FROM problem ORDER BY created_at
        DESC LIMIT #{offset}, #{limit} </select>

    <!-- 根据难度查询题目 -->
    <select id="findByDifficulty" resultMap="ProblemResultMap"> SELECT * FROM problem WHERE
        difficulty = #{difficulty} ORDER BY created_at DESC </select>

    <!-- 插入新题目 -->
    <insert id="insert" parameterType="com.ssoj.backend.entity.Problem"
        useGeneratedKeys="true" keyProperty="id"> INSERT INTO problem ( title, description,
        input_format, output_format, sample_input, sample_output, difficulty, time_limit,
        memory_limit, author_id, number_of_submissions, number_of_accepted, created_at, updated_at )
        VALUES ( #{title}, #{description}, #{inputFormat}, #{outputFormat}, #{sampleInput},
        #{sampleOutput}, #{difficulty}, #{timeLimit}, #{memoryLimit}, #{authorId}, 0, 0, NOW(),
        NOW() ) </insert>

    <!-- 更新题目 -->
    <update id="update"> UPDATE problem SET title = #{title}, description = #{description},
        input_format = #{inputFormat}, output_format = #{outputFormat}, sample_input =
        #{sampleInput}, sample_output = #{sampleOutput}, difficulty = #{difficulty}, time_limit =
        #{timeLimit}, memory_limit = #{memoryLimit}, updated_at = NOW() WHERE id = #{id} </update>

    <!-- 删除题目 -->
    <delete id="deleteById"> DELETE FROM problem WHERE id = #{id} </delete>

    <!-- 统计题目总数 -->
    <select id="count" resultType="int"> SELECT COUNT(*) FROM problem </select>

    <!-- 搜索题目（按标题或描述） -->
    <select id="searchByKeyword" resultMap="ProblemResultMap"> SELECT * FROM problem WHERE title
        LIKE CONCAT('%', #{keyword}, '%') OR description LIKE CONCAT('%', #{keyword}, '%') ORDER BY
        created_at DESC LIMIT #{offset}, #{limit} </select>

    <!-- 统计搜索结果数 -->
    <select id="countByKeyword" resultType="int"> SELECT COUNT(*) FROM problem WHERE title LIKE
        CONCAT('%', #{keyword}, '%') OR description LIKE CONCAT('%', #{keyword}, '%') </select>

    <!-- 增加题目的提交数 -->
    <update id="incrementSubmissionCount"> UPDATE problem SET number_of_submissions =
        number_of_submissions + 1 WHERE id = #{problemId} </update>

    <!-- 增加题目的通过数 -->
    <update id="incrementAcceptedCount"> UPDATE problem SET number_of_accepted = number_of_accepted
        + 1 WHERE id = #{problemId} </update>

    <!-- 根据标签查询题目 -->
    <select id="findByTag" resultMap="ProblemResultMap"> SELECT p.* FROM problem p JOIN problem_tag
        pt ON p.id = pt.problem_id JOIN tag t ON pt.tag_id = t.id WHERE t.name = #{tagName} ORDER BY
        p.created_at DESC LIMIT #{offset}, #{limit} </select>

    <!-- 统计标签下的题目总数 -->
    <select id="countByTag" resultType="int"> SELECT COUNT(*) FROM problem p JOIN problem_tag pt ON
        p.id = pt.problem_id JOIN tag t ON pt.tag_id = t.id WHERE t.name = #{tagName} </select>

</mapper>
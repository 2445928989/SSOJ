<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssoj.backend.dao.DiscussionMapper">

    <resultMap id="DiscussionResultMap" type="com.ssoj.backend.entity.Discussion">
        <id property="id" column="id" />
        <result property="problemId" column="problem_id" />
        <result property="userId" column="user_id" />
        <result property="parentId" column="parent_id" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="likes" column="likes" />
        <result property="dislikes" column="dislikes" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
        <result property="username" column="username" />
        <result property="nickname" column="nickname" />
        <result property="avatar" column="avatar" />
    </resultMap>

    <select id="findByProblemId" resultMap="DiscussionResultMap"> SELECT d.*, u.username,
        u.nickname, u.avatar FROM discussion d LEFT JOIN user u ON d.user_id = u.id WHERE
        d.problem_id = #{problemId} AND d.parent_id IS NULL ORDER BY d.created_at DESC </select>

    <select id="findByParentId" resultMap="DiscussionResultMap"> SELECT d.*, u.username, u.nickname,
        u.avatar FROM discussion d LEFT JOIN user u ON d.user_id = u.id WHERE d.parent_id =
        #{parentId} ORDER BY d.created_at ASC </select>

    <select id="findById" resultMap="DiscussionResultMap"> SELECT d.*, u.username, u.nickname,
        u.avatar FROM discussion d LEFT JOIN user u ON d.user_id = u.id WHERE d.id = #{id} </select>

    <select id="findAllPaged" resultMap="DiscussionResultMap"> SELECT d.*, u.username, u.nickname,
        u.avatar, p.title as problemTitle, (SELECT COUNT(*) FROM discussion r WHERE r.parent_id =
        d.id) as repliesCount FROM discussion d LEFT JOIN user u ON d.user_id = u.id LEFT JOIN
        problem p ON d.problem_id = p.id <where> d.parent_id IS NULL <if
                test="keyword != null and keyword != ''"> AND (d.content LIKE CONCAT('%',
        #{keyword}, '%') OR u.username LIKE CONCAT('%', #{keyword}, '%') OR u.nickname LIKE
        CONCAT('%', #{keyword}, '%') OR p.title LIKE CONCAT('%', #{keyword}, '%') OR
        CAST(d.problem_id AS CHAR) = #{keyword}) </if>
        </where> ORDER BY d.updated_at DESC
        LIMIT #{offset}, #{limit} </select>

    <select id="countAll" resultType="int"> SELECT COUNT(*) FROM discussion d LEFT JOIN user u ON
        d.user_id = u.id LEFT JOIN problem p ON d.problem_id = p.id <where>
            <if test="keyword != null and keyword != ''"> (d.content LIKE CONCAT('%', #{keyword},
        '%') OR u.username LIKE CONCAT('%', #{keyword}, '%') OR u.nickname LIKE CONCAT('%',
        #{keyword}, '%') OR p.title LIKE CONCAT('%', #{keyword}, '%') OR CAST(d.problem_id AS CHAR)
        = #{keyword}) </if>
        </where>
    </select>

    <insert id="insert" parameterType="com.ssoj.backend.entity.Discussion" useGeneratedKeys="true"
        keyProperty="id"> INSERT INTO discussion (problem_id, user_id, parent_id, title, content,
        created_at, updated_at) VALUES (#{problemId}, #{userId}, #{parentId}, #{title}, #{content},
        NOW(), NOW()) </insert>

    <update id="updateLikes"> UPDATE discussion SET likes = likes + #{delta} WHERE id = #{id} </update>

    <update id="updateDislikes"> UPDATE discussion SET dislikes = dislikes + #{delta} WHERE id =
        #{id} </update>

    <delete id="deleteById"> DELETE FROM discussion WHERE id = #{id} </delete>

</mapper>
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssoj.backend.dao.DiscussionMapper">

    <resultMap id="DiscussionResultMap" type="com.ssoj.backend.entity.Discussion">
        <id property="id" column="id" />
        <result property="problemId" column="problem_id" />
        <result property="userId" column="user_id" />
        <result property="parentId" column="parent_id" />
        <result property="title" column="title" />
        <result property="content" column="content" />
        <result property="likes" column="likes" />
        <result property="dislikes" column="dislikes" />
        <result property="isDeleted" column="is_deleted" />
        <result property="createdAt" column="created_at" />
        <result property="updatedAt" column="updated_at" />
        <result property="username" column="username" />
        <result property="nickname" column="nickname" />
        <result property="avatar" column="avatar" />
        <result property="replyToUserId" column="reply_to_user_id" />
        <result property="replyToUsername" column="reply_to_username" />
    </resultMap>

    <select id="findByProblemId" resultMap="DiscussionResultMap"> SELECT d.*, u.username,
        u.nickname, u.avatar, pu.id as reply_to_user_id, pu.username as reply_to_username FROM
        discussion d LEFT JOIN user u ON d.user_id = u.id LEFT JOIN discussion p ON d.parent_id =
        p.id LEFT JOIN user pu ON p.user_id = pu.id WHERE d.problem_id = #{problemId} ORDER BY
        d.created_at DESC </select>

    <select id="findByParentId" resultMap="DiscussionResultMap"> SELECT d.*, u.username, u.nickname,
        u.avatar, pu.id as reply_to_user_id, pu.username as reply_to_username FROM discussion d LEFT
        JOIN user u ON d.user_id = u.id LEFT JOIN discussion p ON d.parent_id = p.id LEFT JOIN user
        pu ON p.user_id = pu.id WHERE d.parent_id = #{parentId} ORDER BY d.created_at ASC </select>

    <select id="findById" resultMap="DiscussionResultMap"> SELECT d.*, u.username, u.nickname,
        u.avatar, pu.id as reply_to_user_id, pu.username as reply_to_username FROM discussion d LEFT
        JOIN user u ON d.user_id = u.id LEFT JOIN discussion p ON d.parent_id = p.id LEFT JOIN user
        pu ON p.user_id = pu.id WHERE d.id = #{id} </select>

    <select id="findDescendants" resultMap="DiscussionResultMap"> WITH RECURSIVE descendants AS (
        SELECT * FROM discussion WHERE id = #{id} UNION ALL SELECT d.* FROM discussion d INNER JOIN
        descendants ON d.parent_id = descendants.id ) SELECT d.*, u.username, u.nickname, u.avatar,
        pu.id as reply_to_user_id, pu.username as reply_to_username FROM descendants d LEFT JOIN
        user u ON d.user_id = u.id LEFT JOIN discussion p ON d.parent_id = p.id LEFT JOIN user pu ON
        p.user_id = pu.id WHERE d.id != #{id} ORDER BY d.created_at ASC </select>

    <select id="findAllPaged" resultMap="DiscussionResultMap"> WITH RECURSIVE tree AS ( SELECT id,
        id as root_id FROM discussion WHERE parent_id IS NULL UNION ALL SELECT d.id, t.root_id FROM
        discussion d INNER JOIN tree t ON d.parent_id = t.id ), reply_counts AS ( SELECT root_id,
        COUNT(*) - 1 as total_replies FROM tree GROUP BY root_id ) SELECT d.*, u.username,
        u.nickname, u.avatar, p.title as problemTitle, COALESCE(rc.total_replies, 0) as repliesCount
        FROM discussion d LEFT JOIN user u ON d.user_id = u.id LEFT JOIN problem p ON d.problem_id =
        p.id LEFT JOIN reply_counts rc ON d.id = rc.root_id <where> d.parent_id IS NULL AND
        d.is_deleted = FALSE <if
                test="keyword != null and keyword != ''"> AND (d.content LIKE CONCAT('%',
        #{keyword}, '%') OR u.username LIKE CONCAT('%', #{keyword}, '%') OR u.nickname LIKE
        CONCAT('%', #{keyword}, '%') OR p.title LIKE CONCAT('%', #{keyword}, '%') OR
        CAST(d.problem_id AS CHAR) = #{keyword}) </if>
        </where>
        <choose>
            <when test="sort == 'activity'"> ORDER BY d.updated_at DESC </when>
            <otherwise> ORDER BY d.created_at DESC </otherwise>
        </choose> LIMIT #{offset},
        #{limit} </select>

    <update id="updateUpdatedAt"> UPDATE discussion SET updated_at = NOW() WHERE id = #{id} </update>

    <select id="countAll" resultType="int"> SELECT COUNT(*) FROM discussion d LEFT JOIN user u ON
        d.user_id = u.id LEFT JOIN problem p ON d.problem_id = p.id <where> d.parent_id IS NULL AND
        d.is_deleted = FALSE <if
                test="keyword != null and keyword != ''"> AND (d.content LIKE CONCAT('%',
        #{keyword}, '%') OR u.username LIKE CONCAT('%', #{keyword}, '%') OR u.nickname LIKE
        CONCAT('%', #{keyword}, '%') OR p.title LIKE CONCAT('%', #{keyword}, '%') OR
        CAST(d.problem_id AS CHAR) = #{keyword}) </if>
        </where>
    </select>

    <insert id="insert" parameterType="com.ssoj.backend.entity.Discussion" useGeneratedKeys="true"
        keyProperty="id"> INSERT INTO discussion (problem_id, user_id, parent_id, title, content,
        created_at, updated_at) VALUES (#{problemId}, #{userId}, #{parentId}, #{title}, #{content},
        NOW(), NOW()) </insert>

    <update id="updateLikes"> UPDATE discussion SET likes = likes + #{delta} WHERE id = #{id} </update>

    <update id="updateDislikes"> UPDATE discussion SET dislikes = dislikes + #{delta} WHERE id =
        #{id} </update>

    <update id="softDeleteById"> UPDATE discussion SET is_deleted = TRUE WHERE id = #{id} </update>

    <delete id="deleteById"> DELETE FROM discussion WHERE id = #{id} </delete>

</mapper>